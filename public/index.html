<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç¶²çµ¡ç›£æ§ç³»çµ±</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- é€£çµç¨ç«‹ CSS -->
  <link rel="stylesheet" href="styles.css">
  <!-- å¼•å…¥ Chart.js UMD ç‰ˆ 4.4.0 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* å°è¢å¹•éŸ¿æ‡‰å¼èª¿æ•´ */
    @media only screen and (max-width: 600px) {
      h1 { font-size: 1.4em; }
      table, th, td { font-size: 0.85em; }
      #settingsModalContent { max-width: 95%; }
      .section { padding: 5px; }
      button { font-size: 0.85em; padding: 5px 8px; }
    }
  </style>
</head>
<body>
  <h1>ç¶²çµ¡ç›£æ§ç³»çµ±</h1>
  <div id="statusMessage">ğŸ“¡ ç›£æ§ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
  <div id="lastUpdate">æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š-</div>

  <table id="statusTable">
    <thead>
      <tr>
        <th>åˆ†è¡Œ</th>
        <th>IP</th>
        <th>ç‹€æ…‹</th>
        <th>å¹³å‡å»¶é² (ms)</th>
        <th>ä¸ŸåŒ…ç‡</th>
        <th>è©•åƒ¹</th>
      </tr>
    </thead>
    <tbody id="branchStatus">
      <tr><td colspan="6">âŒ› è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>

  <div style="text-align: center; margin-top: 5px;">
    <a href="#" onclick="openSettingsModal()">è¨­å®šç®¡ç†</a>
  </div>

  <!-- ç›£æ§æ­·å²ç´€éŒ„å±•ç¤ºå€ -->
  <div id="historySection">
    <h3>ç›£æ§æ­·å²ç´€éŒ„ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
    <!-- è‹¥éœ€å¼·åˆ¶æŒ‡å®šå°ºå¯¸ï¼Œå¯åœ¨ inline style æŒ‡å®š -->
    <canvas id="historyChart" style="width:95%; height:400px;"></canvas>
    <button type="button" onclick="loadHistoryData()">é‡æ–°è¼‰å…¥æ­·å²æ•¸æ“š</button>
    <button type="button" onclick="exportCSV()">å°å‡º CSV</button>
    <div id="historyError" class="error"></div>
  </div>

  <!-- ç³»çµ±æ—¥èªŒå±•ç¤ºå€ -->
  <div id="logSection">
    <h3>ç³»çµ±æ—¥èªŒ</h3>
    <pre id="logContent" style="background: #f0f0f0; padding: 10px; height: 300px; overflow: auto;"></pre>
    <button type="button" onclick="loadLogs()">é‡æ–°è¼‰å…¥æ—¥èªŒ</button>
    <div id="logError" class="error"></div>
  </div>

  <!-- è¨­å®šç®¡ç† Modal -->
  <div id="settingsModal">
    <div id="settingsModalContent">
      <span class="closeBtn" onclick="closeSettingsModal()">&times;</span>
      <h2>è¨­å®šç®¡ç†</h2>
      
      <!-- åˆ†è¡Œè¨­å®š -->
      <div class="section" id="modalBranchesSection">
        <h3>åˆ†è¡Œè¨­å®š</h3>
        <table class="settingsTable" id="branchesSettingsTable">
          <thead>
            <tr>
              <th>åˆ†è¡Œåç¨±</th>
              <th>IP ä½å€</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <!-- åˆ†è¡Œè³‡æ–™å‹•æ…‹è¼‰å…¥ -->
          </tbody>
        </table>
        <button onclick="addBranchRow()">æ–°å¢åˆ†è¡Œ</button>
        <button onclick="saveBranchesSettings()">å„²å­˜åˆ†è¡Œè¨­å®š</button>
        <div id="branchesSettingsMsg" class="message"></div>
      </div>
      
      <!-- Recipients è¨­å®š -->
      <div class="section" id="modalRecipientsSection">
        <h3>Recipients è¨­å®š</h3>
        <form id="recipientsConfigForm">
          <div class="form-row">
            <label for="recipientsToModal">To:</label>
            <input type="text" id="recipientsToModal" placeholder="ä¾‹å¦‚: a@example.com,b@example.com">
          </div>
          <div class="form-row">
            <label for="recipientsCcModal">Cc:</label>
            <input type="text" id="recipientsCcModal" placeholder="ä¾‹å¦‚: c@example.com">
          </div>
          <div class="form-row">
            <label for="recipientsBccModal">Bcc:</label>
            <input type="text" id="recipientsBccModal" placeholder="ä¾‹å¦‚: d@example.com">
          </div>
          <div class="form-row button-row">
            <button type="button" onclick="saveRecipientsModal()">å„²å­˜ Recipients è¨­å®š</button>
            <button type="button" onclick="testRecipientsModal()">å‚³é€æ¸¬è©¦</button>
          </div>
          <div id="recipientsModalMsg" class="message"></div>
        </form>
      </div>
      
      <!-- Email è¨­å®š -->
      <div class="section" id="modalEmailSection">
        <h3>Email è¨­å®š</h3>
        <form id="emailConfigForm">
          <div class="form-row">
            <label for="emailHostModal">SMTP Host:</label>
            <input type="text" id="emailHostModal" placeholder="ä¾‹å¦‚: smtp.example.com">
          </div>
          <div class="form-row">
            <label for="emailPortModal">Port:</label>
            <input type="number" id="emailPortModal" placeholder="ä¾‹å¦‚: 587">
          </div>
          <div class="form-row checkbox-row">
            <label class="checkbox-label">
              <input type="checkbox" id="emailSecureModal">
              ä½¿ç”¨å®‰å…¨é€£ç·š (Secure)
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="emailRequireTLSModal">
              requireTLS
            </label>
          </div>
          <div class="form-row">
            <label for="emailUserModal">ç™¼ä»¶äººå¸³è™Ÿ:</label>
            <input type="text" id="emailUserModal" placeholder="your-email@example.com">
          </div>
          <button type="button" class="medium-btn" onclick="saveEmailConfigModal()">å„²å­˜ Email è¨­å®š</button>
          <div id="emailModalMsg" class="message"></div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // çµ±ä¸€æç¤ºè¨Šæ¯å‡½å¼ï¼šæŒ‡å®šå…ƒç´  IDã€è¨Šæ¯åŠé è¨­ 3000 æ¯«ç§’å¾Œæ¸…é™¤
    function showMessage(elementId, message, timeout = 3000) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerText = message;
        setTimeout(() => {
          element.innerText = "";
          element.className = "";
        }, timeout);
      }
    }
    
    let historyChart = null;
    
    async function fetchStatus() {
      try {
        const res = await fetch('/status');
        const data = await res.json();
        if (data.status === "è¼‰å…¥ä¸­") {
          document.getElementById("statusMessage").innerText = "ğŸ“¡ ç›£æ§ç³»çµ±æ­£åœ¨å•Ÿå‹•ï¼Œè«‹ç¨å€™...";
          document.getElementById("lastUpdate").innerText = "æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š-";
          return;
        }
        document.getElementById("statusMessage").innerText = "âœ… ç›£æ§ç³»çµ±å·²å•Ÿå‹•";
        document.getElementById("lastUpdate").innerText = "æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š" + data.lastUpdate;
        updateTable(data.branches);
      } catch (err) {
        console.error("ç²å–ç›£æ§è³‡æ–™å¤±æ•—ï¼š", err);
        document.getElementById("statusMessage").innerText = "âŒ ç›£æ§ç³»çµ±é€£ç·šå¤±æ•—";
        document.getElementById("lastUpdate").innerText = "æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š-";
      }
    }
    
    function updateTable(branches) {
      const tbody = document.getElementById("branchStatus");
      tbody.innerHTML = "";
      branches.forEach(b => {
        let statusClass = b.alive ? "alive" : "offline";
        let statusIcon = b.alive ? "âœ…" : "âŒ";
        if (b.alive && parseFloat(b.avg) > 500 && parseFloat(b.packetLoss.replace("%", "")) > 10) {
          statusClass = "warning";
          statusIcon = "âš ï¸";
        }
        tbody.innerHTML += `
          <tr>
            <td>${b.branch}</td>
            <td>${b.ip}</td>
            <td class="${statusClass}">${statusIcon}</td>
            <td>${b.avg}</td>
            <td>${b.packetLoss}</td>
            <td>${b.evaluation}</td>
          </tr>
        `;
      });
    }
    
    // æ¯5ç§’æ›´æ–°ç‹€æ…‹
    fetchStatus();
    setInterval(fetchStatus, 5000);
    
    function openSettingsModal() {
      document.getElementById("settingsModal").style.display = "block";
      loadSettings();
    }
    function closeSettingsModal() {
      document.getElementById("settingsModal").style.display = "none";
    }
    function loadSettings() {
      loadBranchesSettings();
      loadRecipientsModal();
      loadEmailConfigModal();
    }
    
    // åˆ†è¡Œè¨­å®šç›¸é—œ (ç•¥ï¼Œä¿ç•™åŸæœ‰é‚è¼¯)
    function addBranchRowModal(name = "", ip = "") {
      const tbody = document.getElementById("branchesSettingsTable").querySelector("tbody");
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      const inputName = document.createElement("input");
      inputName.type = "text";
      inputName.value = name;
      inputName.placeholder = "åˆ†è¡Œåç¨±";
      inputName.className = "small-input";
      tdName.appendChild(inputName);
      tr.appendChild(tdName);
      const tdIP = document.createElement("td");
      const inputIP = document.createElement("input");
      inputIP.type = "text";
      inputIP.value = ip;
      inputIP.placeholder = "IP ä½å€";
      inputIP.className = "small-input";
      tdIP.appendChild(inputIP);
      tr.appendChild(tdIP);
      const tdAction = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.innerText = "åˆªé™¤";
      delBtn.onclick = () => { tbody.removeChild(tr); };
      tdAction.appendChild(delBtn);
      tr.appendChild(tdAction);
      tbody.appendChild(tr);
    }
    function loadBranchesSettings() {
      fetch('/api/branches')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("branchesSettingsTable").querySelector("tbody");
          tbody.innerHTML = "";
          for (let key in data) {
            addBranchRowModal(key, data[key]);
          }
        })
        .catch(() => {
          showMessage("branchesSettingsMsg", "è®€å–åˆ†è¡Œè³‡æ–™å¤±æ•—");
        });
    }
    function addBranchRow() {
      addBranchRowModal();
    }
    function saveBranchesSettings() {
      const tbody = document.getElementById("branchesSettingsTable").querySelector("tbody");
      const rows = tbody.getElementsByTagName("tr");
      const branchesObj = {};
      for (let row of rows) {
        const inputs = row.getElementsByTagName("input");
        const branchName = inputs[0].value.trim();
        const ipAddr = inputs[1].value.trim();
        if (branchName && ipAddr) {
          branchesObj[branchName] = ipAddr;
        }
      }
      fetch('/api/branches', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(branchesObj, null, 2)
      })
        .then(res => res.json())
        .then(() => {
          showMessage("branchesSettingsMsg", "æ›´æ–°æˆåŠŸ");
          fetchStatus();
        })
        .catch(() => {
          showMessage("branchesSettingsMsg", "æ›´æ–°å¤±æ•—");
        });
    }
    
    // Recipients è¨­å®šç›¸é—œ (ç•¥ï¼Œä¿ç•™åŸæœ‰é‚è¼¯)
    function loadRecipientsModal() {
      fetch('/api/recipients')
        .then(res => res.json())
        .then(data => {
          document.getElementById("recipientsToModal").value = (data.to || []).join(",");
          document.getElementById("recipientsCcModal").value = (data.cc || []).join(",");
          document.getElementById("recipientsBccModal").value = (data.bcc || []).join(",");
        })
        .catch(() => {
          showMessage("recipientsModalMsg", "è®€å– Recipients è³‡æ–™å¤±æ•—");
        });
    }
    function saveRecipientsModal() {
      const config = {
        to: document.getElementById("recipientsToModal").value.split(",").map(e => e.trim()).filter(e => e),
        cc: document.getElementById("recipientsCcModal").value.split(",").map(e => e.trim()).filter(e => e),
        bcc: document.getElementById("recipientsBccModal").value.split(",").map(e => e.trim()).filter(e => e)
      };
      fetch('/api/recipients', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config, null, 2)
      })
        .then(res => res.json())
        .then(() => {
          showMessage("recipientsModalMsg", "æ›´æ–°æˆåŠŸ");
        })
        .catch(() => {
          showMessage("recipientsModalMsg", "æ›´æ–°å¤±æ•—");
        });
    }
    function testRecipientsModal() {
      const config = {
        to: document.getElementById("recipientsToModal").value.split(",").map(e => e.trim()).filter(e => e),
        cc: document.getElementById("recipientsCcModal").value.split(",").map(e => e.trim()).filter(e => e),
        bcc: document.getElementById("recipientsBccModal").value.split(",").map(e => e.trim()).filter(e => e)
      };
      fetch('/api/testRecipients', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config, null, 2)
      })
        .then(res => res.json())
        .then(data => {
          showMessage("recipientsModalMsg", data.message || "å‚³é€æ¸¬è©¦æˆåŠŸ");
        })
        .catch(() => {
          showMessage("recipientsModalMsg", "å‚³é€æ¸¬è©¦å¤±æ•—");
        });
    }
    
    // Email è¨­å®šç›¸é—œ (ç•¥ï¼Œä¿ç•™åŸæœ‰é‚è¼¯)
    function loadEmailConfigModal() {
      fetch('/api/emailConfig')
        .then(res => res.json())
        .then(data => {
          document.getElementById("emailHostModal").value = data.host || "";
          document.getElementById("emailPortModal").value = data.port || "";
          document.getElementById("emailSecureModal").checked = data.secure || false;
          document.getElementById("emailRequireTLSModal").checked = data.requireTLS || false;
          document.getElementById("emailUserModal").value = (data.auth && data.auth.user) || "";
        })
        .catch(() => {
          showMessage("emailModalMsg", "è®€å– Email è¨­å®šå¤±æ•—");
        });
    }
    function saveEmailConfigModal() {
      const config = {
        host: document.getElementById("emailHostModal").value.trim(),
        port: parseInt(document.getElementById("emailPortModal").value, 10),
        secure: document.getElementById("emailSecureModal").checked,
        requireTLS: document.getElementById("emailRequireTLSModal").checked,
        auth: { user: document.getElementById("emailUserModal").value.trim() }
      };
      fetch('/api/emailConfig', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config, null, 2)
      })
        .then(res => res.json())
        .then(() => {
          showMessage("emailModalMsg", "æ›´æ–°æˆåŠŸ");
        })
        .catch(() => {
          showMessage("emailModalMsg", "æ›´æ–°å¤±æ•—");
        });
    }
    
    // ã€Œç›£æ§æ­·å²ç´€éŒ„ã€æ›´æ–°èˆ‡æŠ˜ç·šåœ–ç¹ªè£½
    async function loadHistoryData() {
      try {
        const response = await fetch('/historyAPI');
        const records = await response.json();
        if (!Array.isArray(records) || records.length === 0) {
          document.getElementById("historyError").innerText = "ç›®å‰æ²’æœ‰æ­·å²ç´€éŒ„è³‡æ–™å¯é¡¯ç¤º";
          return;
        }
        // å°‡å¹³é¢è³‡æ–™ä¾ timestamp åˆ†çµ„ï¼ˆå‡è¨­åŒä¸€ timestamp å¯èƒ½æœ‰å¤šç­†åˆ†è¡Œè¨˜éŒ„ï¼‰
        const grouped = {};
        records.forEach(record => {
          const ts = record.timestamp;
          if (!grouped[ts]) {
            grouped[ts] = [];
          }
          grouped[ts].push(record);
        });
        // å–å¾—æ’åºå¾Œçš„ timestamp é™£åˆ—
        const timestamps = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));
        //const labels = timestamps.map(ts => new Date(ts).toLocaleTimeString());
		const labels = timestamps.map(ts => new Date(ts).toLocaleString('zh-HK', { month: "numeric", day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }));
  
        // å–å¾—æ‰€æœ‰ä¸åŒçš„åˆ†è¡Œåç¨±
        const branchSet = new Set();
        records.forEach(record => branchSet.add(record.branch));
        const branches = Array.from(branchSet);
        
        // ç‚ºæ¯å€‹åˆ†è¡Œå»ºç«‹è³‡æ–™é™£åˆ—
        const datasets = branches.map(branch => {
          const data = timestamps.map(ts => {
            // æ–¼é€™å€‹æ™‚é–“é»æ‰¾å‡ºè©²åˆ†è¡Œè¨˜éŒ„ï¼ˆå‡è¨­å”¯ä¸€æ€§ï¼‰
            const rec = grouped[ts].find(r => r.branch === branch);
            if (rec) {
              const avgVal = parseFloat(rec.avg);
              return isNaN(avgVal) ? null : avgVal;
            }
            return null;
          });
          return {
            label: branch,
            data,
            borderColor: getRandomColor(),
            fill: false,
            tension: 0.1
          };
        });
  
        const ctx = document.getElementById("historyChart").getContext("2d");
        if (historyChart) {
          historyChart.destroy();
        }
        historyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { title: { display: true, text: "ç›£æ§å»¶é²èµ°å‹¢" } },
            interaction: { mode: "index", intersect: false },
            scales: { y: { beginAtZero: true } }
          }
        });
  
        document.getElementById("historyError").innerText = "";
      } catch (err) {
        console.error("è®€å–ç›£æ§æ­·å²ç´€éŒ„å¤±æ•—:", err);
        document.getElementById("historyError").innerText = "è®€å–ç›£æ§æ­·å²ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }
    
    function getRandomColor() {
      const r = Math.floor(100 + Math.random() * 155);
      const g = Math.floor(100 + Math.random() * 155);
      const b = Math.floor(100 + Math.random() * 155);
      return `rgb(${r}, ${g}, ${b})`;
    }
    
    async function loadLogs() {
      try {
        const res = await fetch('/logs');
        const logsText = await res.text();
        document.getElementById("logContent").innerText = logsText;
        document.getElementById("logError").innerText = "";
      } catch (err) {
        console.error("è®€å–æ—¥èªŒå¤±æ•—:", err);
        document.getElementById("logError").innerText = "è®€å–æ—¥èªŒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }
    
    // æ–°å¢ã€Œå°å‡º CSVã€æŒ‰éˆ•åŠŸèƒ½
    function exportCSV() {
      window.location.href = "/exportHistoryCSV";
    }
    
    // æ¯20ç§’æ›´æ–°æ­·å²ç´€éŒ„æŠ˜ç·šåœ–
    setInterval(loadHistoryData, 20000);
    loadHistoryData();
  </script>
</body>
</html>